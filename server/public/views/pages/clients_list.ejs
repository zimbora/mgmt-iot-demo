<!DOCTYPE html>
<html lang="en">
<head>

  <%- include('../partials/head.ejs') %>

</head>
<body>

  <%- include('../partials/scripts.ejs') %>

  <%- include('../partials/navbar.ejs') %>

  <link href="./assets/css/jquery.dataTables.min.css" rel="stylesheet"></link>
  <script src="./assets/js/jquery.dataTables.min.js"></script>
  <script src="https://kit.fontawesome.com/d69c68b380.js" crossorigin="anonymous"></script>

  <div class="container-fluid">
      <div class="row flex-nowrap">
          <%- include('../partials/sidebar.ejs') %>
          <div class="col py-3">
            <div class="row">
              <div class="col-sm-8 mb-3 mb-sm-0">
                <div class="content-header">
                  <h5>Display MQTT Clients</h5>
                </div>
                <div class="card">
                  <!--<h5 class="card-title">Special title treatment</h5>-->
                  <table id="clients" class="display" style="width:100%">
                    <thead>
                        <tr>
                            <th></th>
                            <th>client</th>
                            <th>user</th>
                            <th>registered</th>
                        </tr>
                    </thead>
                  </table>
                </div>
              </div>
              <div class="col-sm-4 mb-2 mb-sm-0">
                <div class="card">
                  <div class="card-header">
                    <p>Add new client</p>
                  </div>
                  <div class="card-body">
                    <div class="input-group mb-3">
                      <span class="input-group-text" >client</span>
                      <input type="text" id="_clientID_" class="form-control" placeholder="mqtt_clientID" aria-label="Username" aria-describedby="basic-addon1">
                    </div>
                    <div class="input-group mb-3">
                      <label class="input-group-text" for="inputGroupSelect01">user</label>
                      <select class="form-select" id="_userID_">
                        <option default>client</option>
                        <option value="admin">admin</option>
                        <option value="support">support</option>
                        <option value="client">client</option>
                        <option value="device">device</option>
                      </select>
                    </div>
                    <button id="submit" type="button" class="btn btn-primary btn-sm">submit</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
      </div>
  </div>

  <!-- check link to more import options https://cdnjs.com/libraries/ace -->
  <!--<script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.min.js" integrity="sha512-s57ywpCtz+4PU992Bg1rDtr6+1z38gO2mS92agz2nqQcuMQ6IvgLWoQ2SFpImvg1rbgqBKeSEq0d9bo9NtBY0w==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>-->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/ace/1.14.0/ace.js" integrity="sha512-WYlXqL7GPpZL2ImDErTX0RMKy5hR17vGW5yY04p9Z+YhYFJcUUFRT31N29euNB4sLNNf/s0XQXZfzg3uKSoOdA==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.29.4/moment-with-locales.min.js" integrity="sha512-42PE0rd+wZ2hNXftlM78BSehIGzezNeQuzihiBCvUEB3CVxHvsShF86wBWwQORNxNINlBPuq7rG4WWhNiTVHFg==" crossorigin="anonymous" referrerpolicy="no-referrer"></script>

  <%- include('../partials/modal/confirmation.ejs') %>
  <%- include('../partials/modal/error.ejs') %>

  <script>
    var t;
    var id;

    $(document).ready(function () {
      t = $('#clients').DataTable();
      api.getClients((err,res)=>{
        if(err) console.log("err:",err)
        else{
          res.forEach((item, i) => {
            addRow(item.idclients,item.idusers,moment(item.timestamp).format('YY/MM/DD LT'));
          });
        }
      });
    });

    function addRow(client_id,user,registered){
      t.row.add([`
        <button id="`+client_id+`" onclick="deleteClient('`+client_id+`');" type="button" class="delete btn btn-secondary btn-sm">
          <i class="fa-solid fa-user-xmark"></i>
        </button>`,
        `<a href="./client/`+client_id+`">`+client_id+`</a>
        `,user,registered]).draw(true);
    }

    function deleteClient(client_id){
      console.log(client_id)
      id = client_id;
      $('#modalConfirmation').modal('show');
    }

    $("#modalProceed").click(()=>{
      console.log("id:",id)
      api.deleteClient(id,(err,res)=>{
        if(err){
          console.log(err)
          //$('#modalErrorBody').text(err);
          $('#error').text("Your request cannot be executed");
          $('#suggestion').text(err);
          $('#modalError').modal('show');
        }else location.reload();
      });
    })

    $("#submit").click(()=>{
      let client = $("#_clientID_").val();
      let user = $("#_userID_").val();
      api.addClient(client,user,(err,res)=>{
        if(err) console.log(err);
        else location.reload();
      });
    });

  </script>

</body>
</html>
